name: Build & Push (debug)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print env
        run: |
          echo "Branch: $GITHUB_REF"
          echo "Actor:  $GITHUB_ACTOR"
          echo "Repo:   $GITHUB_REPOSITORY"
          uname -a

      - name: Show workspace files (root)
        run: |
          echo "== ls -la =="
          ls -la
          echo "== find Dockerfile =="
          (test -f Dockerfile && echo "✅ Dockerfile found in repo root") || (echo "❌ Dockerfile NOT found in repo root!" && exit 1)

      - name: Show Docker version & info (before login)
        run: |
          docker --version
          docker info | sed -n '1,20p' || true

      - name: Sanity check secrets
        run: |
          test -n "${{ secrets.DOCKERHUB_USERNAME }}" || (echo "❌ Missing DOCKERHUB_USERNAME" && exit 1)
          test -n "${{ secrets.DOCKERHUB_TOKEN }}"    || (echo "❌ Missing DOCKERHUB_TOKEN" && exit 1)
          echo "✅ Secrets exist"

      - name: Docker login (password-stdin)
        run: |
          set -euxo pipefail
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Who am I on Docker?
        run: |
          docker info | sed -n '/Username:/p'

      - name: Show Dockerfile head
        run: |
          echo "== head -n 60 Dockerfile =="
          head -n 60 Dockerfile || true

      - name: Build (plain progress, no cache)
        run: |
          set -euxo pipefail
          docker build --progress=plain --no-cache -t "${{ secrets.DOCKERHUB_USERNAME }}/gbcamera:latest" .

      - name: Push
        run: |
          set -euxo pipefail
          docker push "${{ secrets.DOCKERHUB_USERNAME }}/gbcamera:latest"
