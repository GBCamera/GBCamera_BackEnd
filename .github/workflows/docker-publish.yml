name: Build & Push (simple)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Print env
        run: |
          echo "Branch: $GITHUB_REF"
          echo "Actor: $GITHUB_ACTOR"

      - name: Sanity check secrets
        run: |
          test -n "${{ secrets.DOCKERHUB_USERNAME }}" || (echo "❌ Missing DOCKERHUB_USERNAME" && exit 1)
          test -n "${{ secrets.DOCKERHUB_TOKEN }}"    || (echo "❌ Missing DOCKERHUB_TOKEN" && exit 1)
          echo "✅ Secrets exist"

      # 1) Docker 로그인 (password-stdin)
      - name: Docker login
        run: |
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      # 2) 로그인 확인
      - name: Who am I on Docker?
        run: docker info | sed -n '/Username:/p'

      # 3) JDK 세팅 (Dockerfile이 Gradle 빌드하므로 JDK는 없어도 되지만 유지)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 4) 그냥 도커 클라이언트로 빌드/푸시 (buildx 액션 제거)
      - name: Docker build
        run: |
          docker build --pull --no-cache -t "${{ secrets.DOCKERHUB_USERNAME }}/gbcamera:latest" .

      - name: Docker push
        run: |
          docker push "${{ secrets.DOCKERHUB_USERNAME }}/gbcamera:latest"
